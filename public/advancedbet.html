<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>The Caps Game with Feedback</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Overall page styling similar to dashboard */
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
      padding: 20px;
      margin: 0;
      text-align: center;
    }

    h1 {
      margin-bottom: 20px;
    }

    /* Status Section */
    #status {
      background: #eee;
      padding: 10px;
      border-radius: 5px;
      margin: 0 auto 20px;
      max-width: 600px;
    }

    #cntdwnTxt {
      margin-top: 10px;
      font-size: 18px;
      font-weight: bold;
    }

    #status>div {
      margin: 10px 0;
    }

    #status button {
      margin: 5px;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #status button:first-of-type {
      background-color: #2ecc71;
      color: #fff;
    }

    #status button:last-of-type {
      background-color: #e74c3c;
      color: #fff;
    }

    /* Chat Section */
    #chatContainer {
      background: #fff;
      max-width: 600px;
      margin: 0 auto 20px;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      text-align: left;
    }

    #chatContainer h2 {
      margin-top: 0;
    }

    #chatArea {
      height: 64px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      margin-bottom: 10px;
    }

    #chatForm {
      display: flex;
    }

    #chatInput {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }

    #chatForm button {
      padding: 8px 12px;
      background-color: #4285f4;
      border: none;
      color: #fff;
      cursor: pointer;
    }

    /* Betting Section */
    #TotalCoinsPlaying {
      margin: 20px auto;
      font-size: 18px;
      max-width: 600px;
    }

    /* Use consistent id: totalCoins (capital C) */
    #TotalCoinsPlaying span {
      font-weight: bold;
    }

    #bettingSection {
      background: #fff;
      padding: 20px;
      margin: 20px auto;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      text-align: left;
    }

    #bettingSection div {
      margin-bottom: 10px;
    }

    #bettingSection input {
      width: 100px;
      padding: 5px;
      margin-left: 10px;
    }

    /* Offer buttons container */
    #betButtonsContainer {
      display: flex;
      gap: 30px;
      margin-top: 10px;
      justify-content: center;
    }

    #betButtonsContainer button {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #4285f4;
      color: #fff;
    }

    /* Canvas for board */
    canvas {
      background: #fff;
      border: 1px solid #ccc;
      margin: 20px auto;
      display: block;
    }

    /* Bets/Wagers Section */
    #BetsBox {
      background: #fff;
      padding: 20px;
      margin: 20px auto;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      text-align: left;
    }

    #BetsBox h3 {
      margin-top: 0;
    }

    #coinsLeftDiv {
      margin-bottom: 10px;
    }

    #BetsBox table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    #BetsBox th,
    #BetsBox td {
      border: 1px solid #ccc;
      padding: 5px;
      text-align: center;
    }

    #BetsBox input {
      width: 60px;
    }

    /* Sum display */
    #coinsBettDiv {
      margin-top: 10px;
      font-weight: bold;
    }

    /* Other Controls */
    #otherControls {
      margin-top: 20px;
    }

    #otherControls button {
      margin: 5px;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      background-color: #4285f4;
      color: #fff;
      cursor: pointer;
    }

    #otherControls button:hover {
      background-color: #357ae8;
    }
  </style>
</head>

<body>
  <h1>The Caps Game</h1>

  <!-- Status Section -->
  <div id="status">
    Waiting for opponent's bet...
    <div id="cntdwnTxt" style="display: none;">The game will start in: <strong id="cntdwn">30</strong></div>
    <div id="opponentOffer" style="display: none;">
      Your Opponent is betting:<br>
      Coins playing: <strong id="oppCoinsPlaying">100</strong><br>
      Draw: <strong id="oppCcoinsDraw">15</strong><br>
      Conceed: <strong id="oppCoinsConceed">25</strong>
    </div>
    <div id="offerButtons" style="display: none;">
      <button id="acceptOffer">Accept</button>
      <button id="rejectOffer">Reject</button>
    </div>
  </div>

  <!-- Live Chat Section -->
  <div id="chatContainer">
    <h2>Chat</h2>
    <div id="chatArea"></div>
    <form id="chatForm">
      <input type="text" id="chatInput" placeholder="Type a message..." autocomplete="off" />
      <button id="sendMsg">Send</button>
    </form>
  </div>

  <!-- Total Coins Playing -->
  <div id="TotalCoinsPlaying">
    <strong>Total coins that you are playing:</strong> <span id="totalCoins">0</span>
  </div>

  <!-- Betting Section -->
  <div id="bettingSection">
    <div>
      Place coins in the Jackpot <input id="jackpot" type="number" value="0">
    </div>
    <div id="CoinsPlaying">
      Total Coins put on pieces: <input type="number" id="coinsOnPieces" value="0">
    </div>
    <div id="CcoinsDraw">
      Draw: <input id="coinForDraw" type="number" value="0">
    </div>
    <div id="CoinsConceed">
      Conceed: <input id="coinForConcession" type="number" value="0">
    </div>
    <div id="betButtonsContainer">
      <button id="makeOfferButton">Make offer</button>
      <button id="defaultOfferButton">Default offer</button>
      <button id="noBetButton">No Bet (free play)</button>
    </div>
  </div>

  <!-- Game Board Canvas -->
  <canvas id="gameBoard" width="400" height="400"></canvas>

  <!-- Bets/Wagers Section -->
  <div id="BetsBox">
    <h3>Place Bets/Wagers</h3>
    <div id="coinsLeftDiv">
      Coins remaining to put on Pieces: <strong id="coinsLeftForBetting">0</strong>
    </div>
    <table id="wagerTable">
      <thead>
        <tr>
          <th>Piece</th>
          <th>Coins Bet</th>
          <th>Piece</th>
          <th>Coins Bet</th>
          <th>Piece</th>
          <th>Coins Bet</th>
        </tr>
      </thead>
      <tbody>
        <!-- Break into rows of 3 -->
        <tr>
          <td>A</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
          <td>B</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
          <td>C</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
        </tr>
        <tr>
          <td>D</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
          <td>E</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
          <td>F</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
        </tr>
        <tr>
          <td>G</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
          <td>H</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
          <td>I</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
        </tr>
        <tr>
          <td>J</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
          <td>K</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
          <td>L</td>
          <td><input type="number" class="pieceBet" value="0" min="0"></td>
        </tr>
      </tbody>
    </table>
    <button id="spreadEqualButton">Spread bet on pieces equally</button>
    <button id="spreadRandomButton">Spread bets on pieces randomly</button>
    <div id="coinsBettDiv">
      Sum of coins put on Pieces: <strong id="coinsBetSum">0</strong>
    </div>
  </div>

  <!-- Other Controls -->
  <div id="otherControls">
    <button id="dashboardBtn">Dashboard</button>
    <button id="buyMoreCoins">Purchase More Coins</button>
    <button id="backToLobby">Back to Lobby</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    io.on('connection', (socket) => {
      console.log('A user connected: ' + socket.id);

      // (Existing logic for lobby mode and game mode here)

      // Advanced Betting: if a roomId is provided in the handshake query, assume the socket is in an advanced betting session.
      const bettingRoom = socket.handshake.query.roomId;
      if (bettingRoom) {
        socket.join(bettingRoom);
        console.log(`${socket.username} joined betting room ${bettingRoom}`);

        // Handle offerMade event: store the offer and forward it to the other player.
        socket.on('offerMade', (offerData) => {
          socket.offerData = offerData;
          console.log(`${socket.username} made an offer:`, offerData);
          // Forward the offer to the other socket in the room.
          socket.to(bettingRoom).emit('offerReceived', { challenger: socket.username, offerData });
        });

        // Handle offerResponse event: store the response and notify the room.
        socket.on('offerResponse', (response) => {
          // response should be an object: { accepted: true/false }
          socket.offerResponse = response.accepted;
          console.log(`${socket.username} responded with accepted: ${response.accepted}`);
          // Notify the other player of this response.
          socket.to(bettingRoom).emit('offerResponse', { from: socket.username, accepted: response.accepted });

          // Now check if both players in the room have accepted.
          const clients = io.sockets.adapter.rooms.get(bettingRoom);
          if (clients) {
            let acceptedCount = 0;
            let totalCount = 0;
            for (const clientId of clients) {
              const clientSocket = io.sockets.sockets.get(clientId);
              if (clientSocket) {
                totalCount++;
                if (clientSocket.offerResponse === true) acceptedCount++;
              }
            }
            if (totalCount === 2 && acceptedCount === 2) {
              // Both players accepted.
              console.log("Both players accepted the offer in room:", bettingRoom);
              io.to(bettingRoom).emit('offerBothAccepted');
            }
          }
        });
      }

      // (Other socket event handlers follow below.)
    });

    /***********************
    * Global Variables & Initial Setup
    ***********************/

    let totalCoinsPlaying = 0; // Fake total coins playing (sum of pot, pieces, draw, concession)
    let coinsAvailable = 0;    // Fake coins available for wagers on pieces

    // Set initial display values
    document.getElementById('totalCoins').innerText = totalCoinsPlaying;
    document.getElementById('coinsLeftForBetting').innerText = coinsAvailable;

    // When coinsOnPieces changes, update default wagers for pieces
    const coinsOnPiecesInput = document.getElementById('coinsOnPieces');
    const pieceBetInputs = document.querySelectorAll('.pieceBet');

    function updateWagerDefaults() {
      const coinsOnPieces = parseInt(coinsOnPiecesInput.value) || 0;
      const defaultBet = Math.floor(coinsOnPieces / 12);
      pieceBetInputs.forEach(input => input.value = defaultBet);
      updateWagerSum();
    }

    coinsOnPiecesInput.addEventListener('input', updateWagerDefaults);
    updateWagerDefaults();

    // Validate and update total wager sum
    function updateWagerSum() {
      let sum = 0;
      pieceBetInputs.forEach(input => {
        sum += parseInt(input.value) || 0;
      });
      document.getElementById('coinsBetSum').innerText = sum;
      // Also update coins left for betting:
      const coinsOnPieces = parseInt(coinsOnPiecesInput.value) || 0;
      document.getElementById('coinsLeftForBetting').innerText = Math.max(0, coinsOnPieces - sum);
    }

    pieceBetInputs.forEach(input => {
      input.addEventListener('input', updateWagerSum);
    });

    /***********************
     * Betting Section Buttons Logic
     ***********************/
    // (Optional: update total coins display when betting inputs change)
    document.getElementById('bettingSection').addEventListener('click', function () {
      const jackpot = parseInt(document.getElementById('jackpot').value) || 0;
      const coinsOnPieces = parseInt(document.getElementById('coinsOnPieces').value) || 0;
      const coinForDraw = parseInt(document.getElementById('coinForDraw').value) || 0;
      const coinForConcession = parseInt(document.getElementById('coinForConcession').value) || 0;
      // Update the total coins display
      document.getElementById('totalCoins').innerText = jackpot + coinsOnPieces + coinForDraw + coinForConcession;
    });

    document.getElementById('makeOfferButton').addEventListener('click', function () {
      const jackpot = parseInt(document.getElementById('jackpot').value) || 0;
      const coinsOnPieces = parseInt(document.getElementById('coinsOnPieces').value) || 0;
      const coinForDraw = parseInt(document.getElementById('coinForDraw').value) || 0;
      const coinForConcession = parseInt(document.getElementById('coinForConcession').value) || 0;

      // Gather piece wagers into an object.
      let wagers = {};
      const pieces = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L'];
      pieceBetInputs.forEach((input, index) => {
        wagers[pieces[index]] = parseInt(input.value) || 0;
      });

      const offerData = {
        jackpot,
        coinsOnPieces,
        coinForDraw,
        coinForConcession,
        wagers,
        totalCoinsPlaying
      };
      console.log("Offer Data:", offerData);
      // Send offerData to opponent via socket.io.
      socket.emit('offerMade', offerData);
      alert("Offer made! Waiting for opponent's response...");
    });

    document.getElementById('defaultOfferButton').addEventListener('click', function () {
      // For default offer, fill in some default values.
      document.getElementById('jackpot').value = Math.floor(totalCoinsPlaying * 0.3);
      document.getElementById('coinsOnPieces').value = Math.floor(totalCoinsPlaying * 0.4);
      document.getElementById('coinForDraw').value = Math.floor(totalCoinsPlaying * 0.1);
      document.getElementById('coinForConcession').value = Math.floor(totalCoinsPlaying * 0.2);
      updateWagerDefaults();
      alert("Default offer set. Click 'Make offer' to send.");
    });

    document.getElementById('noBetButton').addEventListener('click', function () {
      // Free play: redirect to game page with betting mode off.
      window.location.href = '/game?mode=free';
    });

    /***********************
     * Spread Bet Buttons Logic
     ***********************/
    document.getElementById('spreadEqualButton').addEventListener('click', function () {
      const coinsOnPieces = parseInt(coinsOnPiecesInput.value) || 0;
      const equalBet = Math.floor(coinsOnPieces / 12);
      pieceBetInputs.forEach(input => input.value = equalBet);
      updateWagerSum();
    });

    document.getElementById('spreadRandomButton').addEventListener('click', function () {
      const coinsOnPieces = parseInt(coinsOnPiecesInput.value) || 0;
      let remaining = coinsOnPieces;
      pieceBetInputs.forEach((input, index) => {
        if (index === pieceBetInputs.length - 1) {
          input.value = remaining;
        } else {
          const maxForThis = Math.floor(remaining / (pieceBetInputs.length - index));
          const randomBet = Math.floor(Math.random() * (maxForThis + 1));
          input.value = randomBet;
          remaining -= randomBet;
        }
      });
      updateWagerSum();
    });

    /***********************
     * Offer Response: Accept / Reject
     ***********************/
    document.getElementById('acceptOffer').addEventListener('click', function () {
      socket.emit('offerResponse', { accepted: true });
      alert("Offer accepted! Waiting for opponent...");
      // After both accept, the server will send "offerBothAccepted".
    });

    document.getElementById('rejectOffer').addEventListener('click', function () {
      socket.emit('offerResponse', { accepted: false });
      alert("Offer rejected. Waiting for new offer...");
      document.getElementById('offerButtons').style.display = 'none';
      document.getElementById('opponentOffer').style.display = 'none';
    });

    socket.on('offerBothAccepted', () => {
      alert("Both players accepted! Game will start in 5 seconds.");
      startCountdown(5);
    });

    function startCountdown(seconds) {
      const cntdwnTxt = document.getElementById('cntdwnTxt');
      const cntdwnElem = document.getElementById('cntdwn');
      cntdwnTxt.style.display = 'block';
      let counter = seconds;
      cntdwnElem.innerText = counter;
      const timer = setInterval(() => {
        counter--;
        cntdwnElem.innerText = counter;
        if (counter <= 0) {
          clearInterval(timer);
          window.location.href = '/game';
        }
      }, 1000);
    }

    /***********************
     * Canvas Board Drawing (Placeholder with Enemy Pieces)
     ***********************/
    function drawBoard() {
      const canvas = document.getElementById('gameBoard');
      const ctx = canvas.getContext('2d');
      const rows = 8, cols = 8;
      const cellSize = canvas.width / cols;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw grid
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          ctx.strokeStyle = '#ccc';
          ctx.strokeRect(c * cellSize, r * cellSize, cellSize, cellSize);
        }
      }
      // Draw enemy pieces (top three rows) with "?" marks.
      ctx.font = '16px Arial';
      ctx.fillStyle = '#ff0000';
      // Row 0: columns 1 to 6 get "?"
      for (let c = 1; c <= 6; c++) {
        const x = c * cellSize + cellSize / 2 - 5;
        const y = 0 * cellSize + cellSize / 2 + 5;
        ctx.fillText("?", x, y);
      }
      // Row 1: columns 2 to 5 get "?"
      for (let c = 2; c <= 5; c++) {
        const x = c * cellSize + cellSize / 2 - 5;
        const y = 1 * cellSize + cellSize / 2 + 5;
        ctx.fillText("?", x, y);
      }
      // Row 2: columns 3 to 4 get "?"
      for (let c = 3; c <= 4; c++) {
        const x = c * cellSize + cellSize / 2 - 5;
        const y = 2 * cellSize + cellSize / 2 + 5;
        ctx.fillText("?", x, y);
      }
      // Draw friendly pieces (bottom rows) with labels.
      ctx.fillStyle = '#333';
      const bottomLabels = ['A', 'B', 'C', 'D', 'E', 'F'];
      for (let i = 0; i < bottomLabels.length; i++) {
        const x = (i + 1) * cellSize + cellSize / 2 - 5;
        const y = 7 * cellSize + cellSize / 2 + 5;
        ctx.fillText(bottomLabels[i], x, y);
      }
      const middleLabels = ['G', 'H', 'I', 'J'];
      for (let i = 0; i < middleLabels.length; i++) {
        const x = (i + 2) * cellSize + cellSize / 2 - 5;
        const y = 6 * cellSize + cellSize / 2 + 5;
        ctx.fillText(middleLabels[i], x, y);
      }
      const topLabels = ['K', 'L'];
      for (let i = 0; i < topLabels.length; i++) {
        const x = (i + 3) * cellSize + cellSize / 2 - 5;
        const y = 5 * cellSize + cellSize / 2 + 5;
        ctx.fillText(topLabels[i], x, y);
      }
    }
    drawBoard();

    /***********************
     * Other Controls
     ***********************/
    document.getElementById('dashboardBtn').addEventListener('click', () => {
      window.location.href = '/dashboard';
    });
    document.getElementById('buyMoreCoins').addEventListener('click', () => {
      window.location.href = '/payments';
    });
    document.getElementById('backToLobby').addEventListener('click', () => {
      window.location.href = '/lobby';
    });

    /***********************
     * Chat Functionality (Placeholder)
     ***********************/
    // Use the same socket for both betting and chat.
    // Remove duplicate socket initialization.
    // (Assuming socket was initialized at the top.)
    const chatFormElem = document.getElementById('chatForm');
    const chatInputElem = document.getElementById('chatInput');
    const chatAreaElem = document.getElementById('chatArea');

    const sendMsgBtn = document.getElementById('sendMsg');
    // const chatInput = document.getElementById('chatInput');
    // const chatArea = document.getElementById('chatArea');

    sendMsgBtn.addEventListener('click', function (e) {
      e.preventDefault();
      const message = chatInput.value.trim();
      if (message) {
        // TODO: Emit chat message to server
        socket.emit('lobbyMessage', { username: 'You', message });
        addChatMessage('You', message);
        chatInput.value = '';
      }
    });

    // chatFormElem.addEventListener('submit', function (e) {
    //   e.preventDefault(); // Prevent page refresh.
    //   const message = chatInputElem.value.trim();
    //   if (message) {
    //     // Emit chat message to server.
    //     socket.emit('lobbyMessage', { username: 'You', message });
    //     addChatMessage('You', message);
    //     chatInputElem.value = '';
    //   }
    // });

    socket.on('lobbyMessage', data => {
      addChatMessage(data.username, data.message);
    });

    function addChatMessage(username, message) {
      const msgDiv = document.createElement('div');
      msgDiv.innerText = username + ": " + message;
      chatAreaElem.appendChild(msgDiv);
      chatAreaElem.scrollTop = chatAreaElem.scrollHeight;
    }
  </script>
  <!-- Removed external client.js to keep all code on the page -->
</body>

</html>